---
title: "VisCello data preprocessing"
author: "Qin Zhu, Kim Lab, University of Pennsylvania"
output:
  prettydoc::html_pretty:
    theme: architect
    highlight: github
bibliography: bibliography.bib
---
<style type="text/css">

body{ /* Normal  */
      font-size: 12px;
  }
td {  /* Table  */
  font-size: 8px;
}
h1.title {
  font-size: 38px;
}
h1 { /* Header 1 */
  font-size: 28px;
}
h2 { /* Header 2 */
    font-size: 22px;
}
h3 { /* Header 3 */
  font-size: 18px;
}
code.r{ /* Code block */
    font-size: 12px;
}
pre { /* Code block - determines code spacing between lines */
    font-size: 14px;
}
</style>


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


## General data requirement

`VisCello` requires two main data object - an `ExpressionSet` object and a `Cello` object (or list of Cello objects). 

The `ExpressionSet` object is a general class from Bioconductor. See https://bioconductor.org/packages/release/bioc/vignettes/Biobase/inst/doc/ExpressionSetIntroduction.pdf for details. The expression matrix holds 3 key datasets: the expression matrix and the normalized count matrix, the meta data for the samples (cells), and the meta data for the genes.

The `Cello` object is an S4 class specifically designed for visualizing subsets of the single cell data - by storing dimension reduction results of (subsets of) cells that are present in the global ExpressionSet, and any local meta information about the cells, such as clustering results. 

This vignette will describe the preprocessing step for inputing data into VisCello.


## Prepare ExpressionSet object

The `data-raw` folder contains an example dataset and associated meta information from @paul2015transcriptional. The files in the folder are:

* `subset_GSE72857.txt`: Raw gene expression matrix, with column as cells and rows as genes.
* `subset_GSE72857_log2norm.txt`: Log2 normalized expression matrix, same dimension as raw matrix. You can also input any other type of normalized data as long as it matches the dimension of raw data.
* `subset_GSE72857_pmeta.txt`: Meta data for the cells. 

Load the data into R and convert them into ExpressionSet using the following code:

```{r, eval=F}
library(Matrix)
library(Biobase)
raw_df <- read.table("data-raw/GSE72857_raw.txt")
norm_df <- read.table("data-raw/GSE72857_log2norm.txt")
pmeta <- read.table("data-raw/GSE72857_pmeta.txt")
fmeta <- read.table("data-raw/GSE72857_fmeta.txt")
# feature meta Must contain a column id - ensemble id, and correspoinding symbol, the matrix rownames should be ensemble id.
colnames(fmeta) <- c("id", "symbol") 
rownames(fmeta) <- fmeta$id

eset <- new("ExpressionSet",
             assayData = assayDataNew("environment", exprs=Matrix(as.matrix(raw_df), sparse = T), norm_exprs = Matrix(as.matrix(norm_df), sparse = T)),
             phenoData =  new("AnnotatedDataFrame", data = pmeta),
             featureData = new("AnnotatedDataFrame", data =fmeta))

saveRDS(eset, "inst/app/data/eset.rds")
```

Now the expression data and meta information required by VisCello is in place.

## Prepare Cello object

`Cello` object allows embedding of multiple dimension reduction results for different subsets of cells. This allows "zoom-in" analysis on subset of cells as well as differential expression analysis on locally defined clusters. The basic structure of `Cello` is as follows:

* `name`: Name of the cell subset
* `idx` : The index of the cell subset in global expression set.
* `proj` : Named list of projections such as PCA, t-SNE and UMAP. 
* `pmeta` : (Optional) local meta data containing the meta data that's specific to this local cell subset. For example, in global meta data, only one "Cluster" column is allowed. But what if you have different clustering results for different cell subsets? You can store this subset-dependent result inside the local pmeta slot of cello.
* `notes` : (Optional) information about the cell subset to display to the user

Create `Cello` for VisCello, note at least one dimension reduction result must be computed and put in `cello@proj`:

```{r eval=F}
library(irlba)
source("data-raw/preprocess_scripts/cello.R")
source("data-raw/preprocess_scripts/cello_dimR.R")
# Creating a cello for all the cells
cello <- new("Cello", name = "All Data", idx = 1:ncol(eset)) # Index is basically the column index, here all cells are included 

# Code for computing dimension reduction, not all of them is necessary, and you can input your own dimension reduction result into the cello@proj list.
cello <- compute_pca_cello(eset, cello, num_dim = 50) # Compute PCA 
cello <- compute_tsne_cello(eset, cello, use_dim = 30, n_component = 2, perplexity = 30) # Compute t-SNE
cello <- compute_umap_cello(eset, cello, use_dim = 30, n_component = 2, umap_path = "data-raw/preprocess_scripts/python/umap.py") # Compute UMAP, need reticulate and UMAP (python package) to be installed
cello <- compute_umap_cello(eset, cello, use_dim = 30, n_component = 3, umap_path = "data-raw/preprocess_scripts/python/umap.py") # 3D UMAP
```

Create a list to store `Cello` objects and save to data location.

```{r eval=F}
clist <- list()
clist[["All Data"]] <- cello
saveRDS(clist, "inst/app/data/clist.rds") # Note if you change the file name from clist.rds to other name, you need to change the readRDS code in global.R
```

Now all the data required to run cello has been preprocessed.

## Reference

